<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>环境变量助手</title>
    <style>
        /* 全局样式 */
        body {
            /* font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; */
            background-color: rgb(239, 241, 238);
            margin: 0;
            padding: 0;
            font-size: 13px;
        }

        /* 导航栏样式 */
        nav {
            background-color: rgb(239, 241, 238);
            border-bottom: 1px solid #e5e5ea;
            padding: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1;
            /* 确保导航栏在最上层 */
        }

        /* 容器样式 */
        #app {
            background: #f7f7f7;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 0;
            margin-top: 40px;
            /* 给导航栏留出空间 */
            height: calc(100vh - 40px);
            /* 减去导航栏的高度 */
            overflow-y: hidden;
            /* 隐藏容器的滚动条 */
        }

        /* 列表样式 */
        ul {
            padding: 0;
            margin: 0;
            height: 100%;
            /* 占满容器高度 */
            overflow-y: auto;
            /* 当内容超出高度时显示垂直滚动条 */
            counter-reset: line-number;
            /* 初始化行号计数器 */
        }

        li {
            line-height: 15px;
            list-style-type: none;
            padding: 5px;
            border-bottom: 1px solid #e5e5ea;
            transition: background-color 0.2s ease;
            min-height: 15px;
            display: flex;
            /* 使用 flex 布局 */
            border-right: 1px solid #e5e5ea;
        }

        li::before {
            counter-increment: line-number;
            /* 增加行号计数器 */
            content: counter(line-number);
            /* 显示行号 */
            width: 20px;
            /* 固定行号宽度 */
            text-align: right;
            margin-right: 10px;
            font-size: 10px;
            color: #999;
            /* border-right: 1px solid #e5e5ea; */
        }

        li:hover {
            background-color: #fafafa;
        }

        /* 编辑状态样式 */
        .editable {
            background-color: #f0f0f0;
        }

        /* 输入框和选择框样式 */
        input,
        select {
            padding: 4px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            margin-right: 2px;
            margin-top: 2px;
            margin-bottom: 2px;
        }

        /* 按钮样式 */
        button {
            padding: 4px 8px;
            margin-top: 2px;
            margin-bottom: 2px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #e5e5ea;
        }

        button:active {
            background-color: #d1d1d6;
        }

        /* 保存和取消按钮样式 */
        button:nth-child(odd) {
            background-color: #007aff;
            color: #fff;
        }

        button:nth-child(odd):hover {
            background-color: #0066cc;
        }

        button:nth-child(odd):active {
            background-color: #0052a3;
        }

        /* 添加按钮样式 */
        #add-button {
            background-color: #34c759;
            color: #fff;
        }

        #add-button:hover {
            background-color: #28a745;
        }

        #add-button:active {
            background-color: #218838;
        }

        /* 删除按钮样式 */
        button.delete-button {
            background-color: #ff3b30;
            color: #fff;
        }

        button.delete-button:hover {
            background-color: #d9271e;
        }

        button.delete-button:active {
            background-color: #b32019;
        }

        /* 保存所有按钮样式 */
        #save-all-button {
            margin-right: 10px;
            background-color: #007aff;
            color: #fff;
        }

        #save-all-button:hover {
            background-color: #0066cc;
        }

        #save-all-button:active {
            background-color: #0052a3;
        }

        /* 新增样式：设置不同命令类型的字体颜色 */
        li span.comment {
            color: darkgreen;
        }

        li span.export {
            color: #0066cc;
        }

        li span.alias {
            color: orange;
        }

        /* 滚动条样式 */
        /* 滚动条整体样式 */
        ::-webkit-scrollbar {
            width: 8px;
            background-color: #f7f7f7;
        }

        /* 滚动条滑块样式 */
        ::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }

        /* 滚动条滑块悬停样式 */
        ::-webkit-scrollbar-thumb:hover {
            background-color: #aaa;
        }
    </style>
    <!-- 引入 Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
</head>

<body>
    <div id="app">
        <nav>
            <button id="add-button" @click="addLine">+</button>
            <button id="save-all-button" @click="saveAll" :disabled="!isDataChanged"
                :class="{ 'disabled': !isDataChanged }">
                ✓
            </button>
        </nav>
        <ul>
            <li v-for="(line, index) in envLines" :key="index" @click="editLine(index)"
                :class="{ editable: editingIndex === index }">
                <!-- 根据 commandType 添加不同的类名 -->
                <span v-if="editingIndex!== index" :class="commandType[index]">{{ line }}</span>
                <div v-else>
                    <select v-model="commandType[index]">
                        <option value="export">export</option>
                        <option value="others">others</option>
                        <option value="alias">alias</option>
                        <option value="comment">comment</option>
                    </select>
                    <template v-if="commandType[index] === 'export' || commandType[index] === 'alias'">
                        <input v-model="envName[index]"
                            :disabled="commandType[index] === 'others' || commandType[index] === 'comment'" />
                        <input v-model="envValue[index]" :disabled="commandType[index] === 'comment'" />
                        <input v-model="comment[index]" />
                    </template>
                    <template v-else-if="commandType[index] === 'others'">
                        <input v-model="envLines[index]" />
                    </template>
                    <template v-else-if="commandType[index] === 'comment'">
                        <input v-model="comment[index]" placeholder="Edit comment" />
                    </template>
                    <button @click.stop="saveLine(index)">✓</button>
                    <button @click.stop="cancelEdit(index)">×</button>
                    <button @click.stop="deleteLine(index)" class="delete-button">⇤</button>
                    <!-- 新增行按钮 -->
                    <button @click.stop="addLineBelow(index)">+ 新增行</button>
                </div>
            </li>
        </ul>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        async function loadZProfile() {
            const content = await ipcRenderer.invoke('read-zprofile');
            if (content) {
                const lines = content.split('\n');
                const envLines = [];
                const commandType = [];
                const envName = [];
                const envValue = [];
                const comment = [];
                const singleLineInput = [];
                const originalData = {}; // 新增：用于保存每个索引的原始数据

                lines.forEach((line, index) => {
                    envLines.push(line);
                    if (line.startsWith('#')) {
                        commandType[index] = 'comment';
                        comment[index] = line.slice(1).trim();
                    } else {
                        const commentIndex = line.indexOf('#');
                        let commandPart = line;
                        if (commentIndex > -1) {
                            commandPart = line.slice(0, commentIndex).trim();
                            comment[index] = line.slice(commentIndex + 1).trim();
                        } else {
                            comment[index] = '';
                        }

                        const firstSpaceIndex = commandPart.indexOf(' ');
                        if (firstSpaceIndex > -1) {
                            commandType[index] = commandPart.slice(0, firstSpaceIndex);
                            const restOfCommand = commandPart.slice(firstSpaceIndex + 1);
                            const equalSignIndex = restOfCommand.indexOf('=');
                            if (equalSignIndex > -1) {
                                envName[index] = restOfCommand.slice(0, equalSignIndex);
                                envValue[index] = restOfCommand.slice(equalSignIndex + 1);
                            } else {
                                singleLineInput[index] = restOfCommand;
                                commandType[index] = 'others';
                            }
                        }
                    }
                    // 保存每个索引的原始数据
                    originalData[index] = {
                        commandType: commandType[index],
                        envName: envName[index],
                        envValue: envValue[index],
                        comment: comment[index]
                    };
                });

                // 创建 Vue 实例
                new Vue({
                    el: '#app',
                    data: {
                        envLines: envLines,
                        commandType: commandType,
                        envName: envName,
                        envValue: envValue,
                        comment: comment,
                        singleLineInput: singleLineInput,
                        editingIndex: null,
                        originalLine: '',
                        originalData: originalData // 新增：在 Vue 实例中使用原始数据
                    },
                    computed: {
                        isDataChanged() {
                            // 检查每个数组是否有变化
                            for (let i = 0; i < this.envLines.length; i++) {
                                if (
                                    this.envLines[i] !== this.originalData[i]?.envLines ||
                                    this.commandType[i] !== this.originalData[i]?.commandType ||
                                    this.envName[i] !== this.originalData[i]?.envName ||
                                    this.envValue[i] !== this.originalData[i]?.envValue ||
                                    this.comment[i] !== this.originalData[i]?.comment ||
                                    this.singleLineInput[i] !== this.originalData[i]?.singleLineInput
                                ) {
                                    return true;
                                }
                            }
                            return false;
                        }
                    },
                    methods: {
                        isComment(line) {
                            return line.startsWith('#');
                        },
                        editLine(index) {
                            this.editingIndex = index;
                            this.originalLine = this.envLines[index];
                        },
                        saveLine(index) {
                            if (this.commandType[index] === 'comment') {
                                this.envLines[index] = `#${this.comment[index]}`;
                            } else if (this.commandType[index] === 'export' || this.commandType[index] === 'alias') {
                                let newLine;
                                if (!this.envName[index]) {
                                    newLine = `${this.commandType[index] || ''} ${this.envValue[index] || ''}`;
                                } else {
                                    let envValueToUse = this.envValue[index];
                                    if (this.commandType[index] === 'alias' && !envValueToUse.startsWith("'") && !envValueToUse.endsWith("'")) {
                                        envValueToUse = `'${envValueToUse}'`;
                                    }
                                    newLine = `${this.commandType[index] || ''} ${this.envName[index] || ''}=${envValueToUse}`;
                                }
                                if (this.comment[index]) {
                                    newLine += ` #${this.comment[index]}`;
                                }
                                this.envLines[index] = newLine.trim();
                            } else if (this.commandType[index] === 'others') {
                                this.envLines[index] = this.envLines[index].trim();
                            }
                            this.editingIndex = null;
                        },
                        cancelEdit(index) {
                            // 恢复原始行文本
                            this.envLines[index] = this.originalLine;
                            // 恢复原始的 commandType、envName、envValue 和 comment
                            this.commandType[index] = this.originalData[index].commandType;
                            this.envName[index] = this.originalData[index].envName;
                            this.envValue[index] = this.originalData[index].envValue;
                            this.comment[index] = this.originalData[index].comment;
                            console.log('Original line restored:', this.envLines[index]);
                            // 退出编辑状态
                            this.editingIndex = null;
                            console.log('Editing index set to null:', this.editingIndex);
                            // 强制更新 DOM
                            this.$forceUpdate();
                        },
                        addLine() {
                            const newIndex = this.envLines.length;
                            this.envLines.push('');
                            this.commandType[newIndex] = 'export';
                            this.envName[newIndex] = '';
                            this.envValue[newIndex] = '';
                            this.comment[newIndex] = '';
                            this.singleLineInput[newIndex] = '';
                            // 保存新增行的原始数据
                            this.originalData[newIndex] = {
                                commandType: 'export',
                                envName: '',
                                envValue: '',
                                comment: ''
                            };
                            this.editingIndex = newIndex;
                        },
                        addLineBelow(index) {
                            const newIndex = index + 1;
                            this.envLines.splice(newIndex, 0, '');
                            this.commandType.splice(newIndex, 0, 'export');
                            this.envName.splice(newIndex, 0, '');
                            this.envValue.splice(newIndex, 0, '');
                            this.comment.splice(newIndex, 0, '');
                            this.singleLineInput.splice(newIndex, 0, '');
                            // 保存新增行的原始数据
                            this.originalData[newIndex] = {
                                commandType: 'export',
                                envName: '',
                                envValue: '',
                                comment: ''
                            };
                            this.editingIndex = newIndex;
                        },
                        deleteLine(index) {
                            this.envLines.splice(index, 1);
                            this.commandType.splice(index, 1);
                            this.envName.splice(index, 1);
                            this.envValue.splice(index, 1);
                            this.comment.splice(index, 1);
                            this.singleLineInput.splice(index, 1);
                            // 删除对应索引的原始数据
                            delete this.originalData[index];
                            this.editingIndex = null;
                        },
                        saveAll() {
                            let content = this.envLines.join('\n');
                            ipcRenderer.invoke('write-zprofile', content).then(success => {
                                if (success) {
                                    alert('Saved .zprofile successfully!');
                                }
                            });
                            // 保存成功后更新原始数据
                            Object.keys(this.originalData).forEach(index => {
                                this.originalData[index] = {
                                    commandType: this.commandType[index],
                                    envName: this.envName[index],
                                    envValue: this.envValue[index],
                                    comment: this.comment[index]
                                };
                            });
                        }
                    }
                });
            }
        }

        loadZProfile();
    </script>
    <style>
        /* 添加禁用按钮样式 */
        button.disabled {
            background-color: #e5e5ea;
            color: #a9a9a9;
            cursor: not-allowed;
        }
    </style>
</body>

</html>