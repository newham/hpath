<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯å¢ƒå˜é‡åŠ©æ‰‹</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            /* font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; */
            background-color: #f7f7f7;
            margin: 0;
            /* padding: 30px 0 0 0; */
            padding: 0;
            /* å¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œé¿å…å†…å®¹è¢«å¯¼èˆªæ é®æŒ¡ */
            font-size: 13px;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        nav {
            background-color: #f7f7f7;
            /* box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1); */
            border-bottom: 1px solid #e5e5ea;
            padding: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            /* å›ºå®šå¯¼èˆªæ  */
            top: 0;
            left: 0;
            width: 100%;
        }

        /* å®¹å™¨æ ·å¼ */
        #app {
            background: #f7f7f7;
            /* border-radius: 12px; */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 0;
            margin-top: 37px;
        }

        /* åˆ—è¡¨æ ·å¼ */
        ul {
            padding: 0;
            margin: 0;
        }

        li {
            line-height: 15px;
            list-style-type: none;
            padding: 5px;
            border-bottom: 1px solid #e5e5ea;
            transition: background-color 0.2s ease;
            min-height: 15px;
        }

        li:hover {
            background-color: #fafafa;
        }

        /* ç¼–è¾‘çŠ¶æ€æ ·å¼ */
        .editable {
            background-color: #f0f0f0;
        }

        /* è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†æ ·å¼ */
        input,
        select {
            padding: 4px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            /* font-size: 14px; */
            margin-right: 2px;
            margin-top: 2px;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            padding: 4px 8px;
            margin-top: 2px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            /* font-size: 14px; */
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #e5e5ea;
        }

        button:active {
            background-color: #d1d1d6;
        }

        /* ä¿å­˜å’Œå–æ¶ˆæŒ‰é’®æ ·å¼ */
        button:nth-child(odd) {
            background-color: #007aff;
            color: #fff;
        }

        button:nth-child(odd):hover {
            background-color: #0066cc;
        }

        button:nth-child(odd):active {
            background-color: #0052a3;
        }

        /* æ·»åŠ æŒ‰é’®æ ·å¼ */
        #add-button {
            background-color: #34c759;
            color: #fff;
        }

        #add-button:hover {
            background-color: #28a745;
        }

        #add-button:active {
            background-color: #218838;
        }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        button.delete-button {
            background-color: #ff3b30;
            color: #fff;
        }

        button.delete-button:hover {
            background-color: #d9271e;
        }

        button.delete-button:active {
            background-color: #b32019;
        }

        /* ä¿å­˜æ‰€æœ‰æŒ‰é’®æ ·å¼ */
        #save-all-button {
            margin-right: 10px;
            background-color: #007aff;
            color: #fff;
        }

        #save-all-button:hover {
            background-color: #0066cc;
        }

        #save-all-button:active {
            background-color: #0052a3;
        }
    </style>
    <!-- å¼•å…¥ Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
</head>

<body>
    <div id="app">
        <nav>
            <button id="add-button" @click="addLine">+</button>
            <button id="save-all-button" @click="saveAll" :disabled="!isDataChanged"
                :class="{ 'disabled': !isDataChanged }">
                âœ“
            </button>
        </nav>
        <ul>
            <li v-for="(line, index) in envLines" :key="index" @click="editLine(index)"
                :class="{ editable: editingIndex === index }">
                <span v-if="editingIndex!== index">{{ line }}</span>
                <div v-else>
                    <select v-model="commandType[index]">
                        <option value="export">export</option>
                        <option value="others">others</option>
                        <option value="alias">alias</option>
                        <option value="comment">comment</option>
                    </select>
                    <template v-if="commandType[index] === 'export' || commandType[index] === 'alias'">
                        <input v-model="envName[index]"
                            :disabled="commandType[index] === 'others' || commandType[index] === 'comment'" />
                        <input v-model="envValue[index]" :disabled="commandType[index] === 'comment'" />
                        <input v-model="comment[index]" />
                    </template>
                    <template v-else-if="commandType[index] === 'others'">
                        <input v-model="envLines[index]" />
                    </template>
                    <template v-else-if="commandType[index] === 'comment'">
                        <input v-model="comment[index]" placeholder="Edit comment" />
                    </template>
                    <button @click.stop="saveLine(index)">âœ“</button>
                    <button @click.stop="cancelEdit(index)">Ã—</button>
                    <button @click.stop="deleteLine(index)" class="delete-button">ğŸ—‘ï¸</button>
                </div>
            </li>
        </ul>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        async function loadZProfile() {
            const content = await ipcRenderer.invoke('read-zprofile');
            if (content) {
                const lines = content.split('\n');
                const envLines = [];
                const commandType = [];
                const envName = [];
                const envValue = [];
                const comment = [];
                const singleLineInput = [];

                lines.forEach((line, index) => {
                    envLines.push(line);
                    if (line.startsWith('#')) {
                        commandType[index] = 'comment';
                        comment[index] = line.slice(1).trim();
                    } else {
                        const commentIndex = line.indexOf('#');
                        let commandPart = line;
                        if (commentIndex > -1) {
                            commandPart = line.slice(0, commentIndex).trim();
                            comment[index] = line.slice(commentIndex + 1).trim();
                        } else {
                            comment[index] = '';
                        }

                        const firstSpaceIndex = commandPart.indexOf(' ');
                        if (firstSpaceIndex > -1) {
                            commandType[index] = commandPart.slice(0, firstSpaceIndex);
                            const restOfCommand = commandPart.slice(firstSpaceIndex + 1);
                            const equalSignIndex = restOfCommand.indexOf('=');
                            if (equalSignIndex > -1) {
                                envName[index] = restOfCommand.slice(0, equalSignIndex);
                                envValue[index] = restOfCommand.slice(equalSignIndex + 1);
                            } else {
                                // å¤„ç†æ²¡æœ‰ç­‰å·çš„æƒ…å†µ
                                singleLineInput[index] = restOfCommand;
                                commandType[index] = 'others';
                            }
                        }
                    }
                });

                // åˆ›å»º Vue å®ä¾‹
                new Vue({
                    el: '#app',
                    data: {
                        envLines: envLines,
                        commandType: commandType,
                        envName: envName,
                        envValue: envValue,
                        comment: comment,
                        singleLineInput: singleLineInput,
                        editingIndex: null,
                        originalLine: '',
                        // ä¿å­˜åŸå§‹æ•°æ®
                        originalEnvLines: [...envLines],
                        originalCommandType: [...commandType],
                        originalEnvName: [...envName],
                        originalEnvValue: [...envValue],
                        originalComment: [...comment],
                        originalSingleLineInput: [...singleLineInput]
                    },
                    computed: {
                        isDataChanged() {
                            // æ£€æŸ¥æ¯ä¸ªæ•°ç»„æ˜¯å¦æœ‰å˜åŒ–
                            return (
                                JSON.stringify(this.envLines) !== JSON.stringify(this.originalEnvLines) ||
                                JSON.stringify(this.commandType) !== JSON.stringify(this.originalCommandType) ||
                                JSON.stringify(this.envName) !== JSON.stringify(this.originalEnvName) ||
                                JSON.stringify(this.envValue) !== JSON.stringify(this.originalEnvValue) ||
                                JSON.stringify(this.comment) !== JSON.stringify(this.originalComment) ||
                                JSON.stringify(this.singleLineInput) !== JSON.stringify(this.originalSingleLineInput)
                            );
                        }
                    },
                    methods: {
                        isComment(line) {
                            return line.startsWith('#');
                        },
                        editLine(index) {
                            this.editingIndex = index;
                            this.originalLine = this.envLines[index];
                            console.log('Original line saved:', this.originalLine);
                        },
                        saveLine(index) {
                            if (this.commandType[index] === 'comment') {
                                this.envLines[index] = `#${this.comment[index]}`;
                            } else if (this.commandType[index] === 'export' || this.commandType[index] === 'alias') {
                                // å¤„ç† export å’Œ alias å‘½ä»¤
                                let newLine;
                                if (!this.envName[index]) {
                                    // å½“ç¯å¢ƒå˜é‡åä¸å­˜åœ¨æ—¶ï¼Œä¸æ‹¼æ¥ç­‰å·
                                    newLine = `${this.commandType[index] || ''} ${this.envValue[index] || ''}`;
                                } else {
                                    let envValueToUse = this.envValue[index];
                                    if (this.commandType[index] === 'alias' && !envValueToUse.startsWith("'") && !envValueToUse.endsWith("'")) {
                                        envValueToUse = `'${envValueToUse}'`;
                                    }
                                    newLine = `${this.commandType[index] || ''} ${this.envName[index] || ''}=${envValueToUse}`;
                                }
                                if (this.comment[index]) {
                                    newLine += ` #${this.comment[index]}`;
                                }
                                this.envLines[index] = newLine.trim();
                            } else if (this.commandType[index] === 'others') {
                                // å¤„ç† others å‘½ä»¤ï¼Œç›´æ¥ä½¿ç”¨è¾“å…¥çš„æ•´è¡Œå†…å®¹
                                this.envLines[index] = this.envLines[index].trim();
                            }
                            this.editingIndex = null;
                        },
                        cancelEdit(index) {
                            // æ¢å¤åŸå§‹è¡Œæ–‡æœ¬
                            this.envLines[index] = this.originalLine;
                            console.log('Original line restored:', this.envLines[index]);
                            // é€€å‡ºç¼–è¾‘çŠ¶æ€
                            this.editingIndex = null;
                            console.log('Editing index set to null:', this.editingIndex);
                            // å¼ºåˆ¶æ›´æ–° DOM
                            this.$forceUpdate();
                        },
                        addLine() {
                            const newIndex = this.envLines.length;
                            this.envLines.push('');
                            this.commandType[newIndex] = 'export';
                            this.envName[newIndex] = '';
                            this.envValue[newIndex] = '';
                            this.comment[newIndex] = '';
                            this.singleLineInput[newIndex] = '';
                            this.editingIndex = newIndex;
                        },
                        deleteLine(index) {
                            this.envLines.splice(index, 1);
                            this.commandType.splice(index, 1);
                            this.envName.splice(index, 1);
                            this.envValue.splice(index, 1);
                            this.comment.splice(index, 1);
                            this.singleLineInput.splice(index, 1);
                            this.editingIndex = null;
                        },
                        saveAll() {
                            let content = this.envLines.join('\n');
                            ipcRenderer.invoke('write-zprofile', content).then(success => {
                                if (success) {
                                    alert('Saved successfully!');
                                }
                            });
                            // ä¿å­˜æˆåŠŸåæ›´æ–°åŸå§‹æ•°æ®
                            this.originalEnvLines = [...this.envLines];
                            this.originalCommandType = [...this.commandType];
                            this.originalEnvName = [...this.envName];
                            this.originalEnvValue = [...this.envValue];
                            this.originalComment = [...this.comment];
                            this.originalSingleLineInput = [...this.singleLineInput];
                        }
                    }
                });
            }
        }

        loadZProfile();
    </script>
    <style>
        /* æ·»åŠ ç¦ç”¨æŒ‰é’®æ ·å¼ */
        button.disabled {
            background-color: #e5e5ea;
            color: #a9a9a9;
            cursor: not-allowed;
        }
    </style>
</body>

</html>